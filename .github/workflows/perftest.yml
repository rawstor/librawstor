name: perftest

on:
  push:

jobs:
  perftest-disable-ost:

    runs-on: ubuntu-latest

    steps:
    - name: install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxxhash-dev
        sudo apt-get install -y liburing-dev
    - uses: actions/checkout@v4
      with:
        path: librawstor
    - name: install librawstor
      run: |
        pushd .
        cd ./librawstor
        ./autogen.sh
        ./configure --disable-ost --disable-shared
        make
        sudo make install
        popd
    - uses: actions/checkout@v4
      with:
        repository: rawstor/fio
        path: fio
        ref: refs/heads/rawstor
    - name: install fio
      run: |
        pushd .
        cd ./fio
        ./configure
        make
        sudo make install
        popd
    - name: fio
      run: |
        object_id=$(rawstor-cli create --size=1)

        echo "# fio --disable-ost" >> $GITHUB_STEP_SUMMARY

        echo "## bs=4k, iodepth=1, numjobs=1" >> $GITHUB_STEP_SUMMARY
        ./librawstor/.github/tools/fio.sh ${object_id} 4k 1 1 fio.txt fio.json
        echo \`\`\` >> $GITHUB_STEP_SUMMARY
        cat fio.txt >> $GITHUB_STEP_SUMMARY
        echo \`\`\` >> $GITHUB_STEP_SUMMARY

        echo "## bs=4k, iodepth=2, numjobs=1" >> $GITHUB_STEP_SUMMARY
        ./librawstor/.github/tools/fio.sh ${object_id} 4k 2 1 fio.txt fio.json
        echo \`\`\` >> $GITHUB_STEP_SUMMARY
        cat fio.txt >> $GITHUB_STEP_SUMMARY
        echo \`\`\` >> $GITHUB_STEP_SUMMARY

  perftest-disable-ost-without-liburing:

    runs-on: ubuntu-latest

    steps:
    - name: install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxxhash-dev
    - uses: actions/checkout@v4
      with:
        path: librawstor
    - name: install librawstor
      run: |
        pushd .
        cd ./librawstor
        ./autogen.sh
        ./configure --disable-ost --without-liburing --disable-shared
        make
        sudo make install
        popd
    - uses: actions/checkout@v4
      with:
        repository: rawstor/fio
        path: fio
        ref: refs/heads/rawstor
    - name: install fio
      run: |
        pushd .
        cd ./fio
        ./configure
        make
        sudo make install
        popd
    - name: fio
      run: |
        object_id=$(rawstor-cli create --size=1)

        echo "# fio --disable-ost --without-liburing" >> $GITHUB_STEP_SUMMARY

        echo "## bs=4k, iodepth=1, numjobs=1" >> $GITHUB_STEP_SUMMARY
        ./librawstor/.github/tools/fio.sh ${object_id} 4k 1 1 fio.txt fio.json
        echo \`\`\` >> $GITHUB_STEP_SUMMARY
        cat fio.txt >> $GITHUB_STEP_SUMMARY
        echo \`\`\` >> $GITHUB_STEP_SUMMARY

        echo "## bs=4k, iodepth=2, numjobs=1" >> $GITHUB_STEP_SUMMARY
        ./librawstor/.github/tools/fio.sh ${object_id} 4k 2 1 fio.txt fio.json
        echo \`\`\` >> $GITHUB_STEP_SUMMARY
        cat fio.txt >> $GITHUB_STEP_SUMMARY
        echo \`\`\` >> $GITHUB_STEP_SUMMARY
