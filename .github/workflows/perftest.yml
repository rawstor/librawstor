name: perftest

on:
  push:

jobs:
  perftest:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        without-liburing:
        - 
        - --without-liburing
        disable-ost:
        -
        - --disable-ost
        bs:
        - 4k
        iodepth:
        - 1
        - 2
        numjobs:
        - 1
        include:
        - packages: liburing-dev
          without-liburing:
        - packages: liburing-dev
          disable-ost:
          without-liburing: --without-liburing

    steps:
    - name: install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxxhash-dev ${{ matrix.packages }}
    - uses: actions/checkout@v4
      with:
        path: librawstor
    - name: install librawstor
      run: |
        pushd .
        cd ./librawstor
        ./autogen.sh
        ./configure --disable-shared ${{ matrix.without-liburing }} ${{ matrix.disable-ost }}
        make
        sudo make install
        popd
    - uses: actions/checkout@v4
      if: "${{ matrix.disable-ost == '' }}"
      with:
        repository: rawstor/rawstor_ost
        path: rawstor_ost
        ref: refs/heads/main
        ssh-key: ${{ secrets.RAWSTOR_OST_TOKEN }}
    - name: (rawstor_ost) install rawstor_ost
      if: "${{ matrix.disable-ost == '' }}"
      run: |
        pushd .
        cd ./rawstor_ost
        ./autogen.sh
        ./configure --disable-shared
        make
        sudo make install
        popd
    - uses: actions/checkout@v4
      with:
        repository: rawstor/fio
        path: fio
        ref: refs/heads/rawstor
    - name: install fio
      run: |
        pushd .
        cd ./fio
        ./configure
        make
        sudo make install
        popd
    - name: (rawstor_ost) start rawstor_ost
      if: "${{ matrix.disable-ost == '' }}"
      run: |
        mkdir /tmp/objects
        truncate -s 2G /tmp/objects/01988675-e1e5-7788-9ed4-2f2d30910d23
        ost 8080 /tmp/objects/ &
        sleep 10
    - name: create object
      if: "${{ matrix.disable-ost != '' }}"
      run: |
        object_id=$(rawstor-cli create --size=1)
        echo "OBJECT_ID=${object_id}" >> $GITHUB_ENV
    - name: (rawstor_ost) create object
      if: "${{ matrix.disable-ost == '' }}"
      run: |
        object_id=01988675-e1e5-7788-9ed4-2f2d30910d23
        echo "OBJECT_ID=${object_id}" >> $GITHUB_ENV
    - name: fio
      run: |
        echo "# fio ${{ matrix.without-liburing }} ${{ matrix.disable-ost }}" >> $GITHUB_STEP_SUMMARY
        echo "## bs=${{ matrix.bs }}, iodepth=${{ matrix.iodepth }}, numjobs=${{ matrix.numjobs }}" >> $GITHUB_STEP_SUMMARY
        ./librawstor/.github/tools/fio.sh \
          ${OBJECT_ID} \
          ${{ matrix.bs }} \
          ${{ matrix.iodepth }} \
          ${{ matrix.numjobs }} \
          fio.txt \
          fio.json
        echo \`\`\` >> $GITHUB_STEP_SUMMARY
        cat fio.txt >> $GITHUB_STEP_SUMMARY
        echo \`\`\` >> $GITHUB_STEP_SUMMARY
    - name: (rawstor_ost) stop rawstor_ost
      if: "${{ matrix.disable-ost == '' }}"
      run: killall ost
    - uses: actions/checkout@v4
      with:
        repository: rawstor/rawstor_bench
        path: rawstor_bench
        ref: refs/heads/main
        ssh-key: ${{ secrets.RAWSTOR_BENCH_TOKEN }}
    - name: publish
      run: |
        ./librawstor/.github/tools/git-config.sh ./librawstor

        ./rawstor_bench/tools/rawstor-bench-import \
          --prefix=./rawstor_bench \
          --repo=librawstor \
          --name=perftest${{ matrix.without-liburing }}${{ matrix.disable-ost }}-${{ matrix.bs }}-${{ matrix.iodepth }}-${{ matrix.numjobs }} \
          --branch="$GITHUB_REF" \
          --commit=$GITHUB_SHA \
          --date="$(date +'%Y-%m-%dT%H:%M:%S%z')" \
          fio \
          fio.txt \
          fio.json

        ./rawstor_bench/tools/rawstor-bench-compile \
          --prefix=./rawstor_bench fio

        ./librawstor/.github/tools/git-commit-and-push.sh \
          ./rawstor_bench \
          "add: perftest ${{ matrix.without-liburing }} ${{ matrix.disable-ost }} benchmarks"
