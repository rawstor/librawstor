name: perftest

on:
  push:

jobs:
  perftest:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        without-liburing:
        - 
        - --without-liburing
        disable-ost:
        - --disable-ost
        bs:
        - 4k
        iodepth:
        - 1
        - 2
        numjobs:
        - 1
        include:
        - packages: liburing-dev
          without-liburing:

    steps:
    - name: install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxxhash-dev ${{ matrix.packages }}
    - uses: actions/checkout@v4
      with:
        path: librawstor
    - name: install librawstor
      run: |
        pushd .
        cd ./librawstor
        ./autogen.sh
        ./configure --disable-shared ${{ matrix.without-liburing }} ${{ matrix.disable-ost }}
        make
        sudo make install
        popd
    - uses: actions/checkout@v4
      with:
        repository: rawstor/fio
        path: fio
        ref: refs/heads/rawstor
    - name: install fio
      run: |
        pushd .
        cd ./fio
        ./configure
        make
        sudo make install
        popd
    - name: fio
      run: |
        object_id=$(rawstor-cli create --size=1)

        echo "# fio ${{ matrix.without-liburing }} ${{ matrix.disable-ost }}" >> $GITHUB_STEP_SUMMARY

        echo "## bs=${{ matrix.bs }}, iodepth=${{ matrix.iodepth }}, numjobs=${{ matrix.numjobs }}" >> $GITHUB_STEP_SUMMARY
        ./librawstor/.github/tools/fio.sh \
          ${object_id} \
          ${{ matrix.bs }} \
          ${{ matrix.iodepth }} \
          ${{ matrix.numjobs }} \
          fio-${{ matrix.bs }}-${{ matrix.iodepth }}-${{ matrix.numjobs }}.txt \
          fio-${{ matrix.bs }}-${{ matrix.iodepth }}-${{ matrix.numjobs }}.json
        echo \`\`\` >> $GITHUB_STEP_SUMMARY
        cat fio-${{ matrix.bs }}-${{ matrix.iodepth }}-${{ matrix.numjobs }}.txt >> $GITHUB_STEP_SUMMARY
        echo \`\`\` >> $GITHUB_STEP_SUMMARY
    - name: upload fio result
      uses: actions/upload-artifact@v4
      with:
        name: perftest${{ matrix.without-liburing }}${{ matrix.disable-ost }}
        path: |
          fio-${{ matrix.bs }}-${{ matrix.iodepth }}-${{ matrix.numjobs }}.txt
          fio-${{ matrix.bs }}-${{ matrix.iodepth }}-${{ matrix.numjobs }}.json
    - uses: actions/checkout@v4
      with:
        repository: rawstor/rawstor_bench
        path: rawstor_bench
        ref: refs/heads/main
        ssh-key: ${{ secrets.RAWSTOR_BENCH_TOKEN }}
    - name: publish
      run: |
        ./librawstor/.github/tools/git-config.sh ./librawstor

        ./rawstor_bench/tools/rawstor-bench-import \
          --prefix=./rawstor_bench \
          --suite=librawstor \
          --name=perftest${{ matrix.without-liburing }}${{ matrix.disable-ost }}-${{ matrix.bs }}-${{ matrix.iodepth }}-${{ matrix.numjobs }} \
          --branch="$GITHUB_REF" \
          --commit=$GITHUB_SHA \
          --date="$(date +'%Y-%m-%dT%H:%M:%S%z')" \
          fio \
          ./perftest${{ matrix.without-liburing }}${{ matrix.disable-ost }}/fio-${{ matrix.bs }}-${{ matrix.iodepth }}-${{ matrix.numjobs }}.txt \
          ./perftest${{ matrix.without-liburing }}${{ matrix.disable-ost }}/fio-${{ matrix.bs }}-${{ matrix.iodepth }}-${{ matrix.numjobs }}.json

        ./rawstor_bench/tools/rawstor-bench-compile \
          --prefix=./rawstor_bench fio

        ./librawstor/.github/tools/git-commit-and-push.sh \
          ./rawstor_bench \
          "add: perftest ${{ matrix.without-liburing }} ${{ matrix.disable-ost }} benchmarks"
